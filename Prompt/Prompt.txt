# (v8.8 - Ultimate Master Prompt) ระบบจัดการเอกสารลงทะเบียนเรียนแบบครบวงจร
# สถาบัน: วิทยาลัยอาชีวศึกษานครปฐม (Nakhon Pathom Vocational College)
# เทคโนโลยีหลัก: Laravel 12, Livewire 3, Spatie Permission, DomPDF, SweetAlert2, Tailwind CSS

---

### [ส่วนที่ I: โครงสร้างฐานข้อมูลและการตั้งค่าระบบ (Database & Models)]

1. การตั้งค่าสิทธิ์ (Spatie Setup):
   - Roles: Admin, Teacher, Registrar, Student
   - Middleware: ลงทะเบียน 'role', 'permission', 'role_or_permission' ใน bootstrap/app.php
   - Model User: ใช้ Trait 'HasRoles'

2. Schema ฐานข้อมูล (13 ตารางหลัก):
   - users: id, username, password, email, created_at
   - students: id, user_id(FK), student_code, firstname, lastname, level_id(FK), citizen_id, class_group_id(FK)
   - levels: id, name (เช่น ปวช.1, ปวส.2, ป.ตรี)
   - teachers: id, teacher_code, title, firstname, lastname, citizen_id, user_id(FK, Nullable)
   - majors: id, major_code, major_name
   - class_groups: id, course_group_code (ใช้เป็น Ref.2 ใน Pay-in), course_group_name, level_id(FK), level_year, major_id(FK), teacher_advisor_id(FK)
   - subjects: id, subject_code, subject_name, credit, hour_theory, hour_practical
   - study_plans: id, semester, year, class_group_id(FK), subject_id(FK), teacher_id(FK)
   - registrations: id, student_id(FK), semester, year, status (pending, approved, rejected), registration_card_file, slip_file_name
   - tuition_fees: id, semester, year, fee_name, rate_money (สำหรับ ปวช. - เก็บแบบรายรายการ)
   - credit_fees: id, semester, year, level_id(FK), credit_fee, lab_fee (สำหรับ ปวส. - หน่วยละ 100)
   - semesters: id, semester, year, registration_start/end_date, late_registration_start/end_date, late_fee_rate (100 บาท), is_active (boolean)

3. Relationships: 
   - กำหนด Eloquent Relationships ครบถ้วน (เช่น Student belongsTo User, ClassGroup hasMany Students)

---

### [ส่วนที่ II: ตรรกะการคำนวณ (Business Logic Engine)]

ให้ใช้ Repository/Service ในการคำนวณยอดเงิน:
1. สาย ปวช.: คำนวณยอดรวมจากตาราง tuition_fees ทั้งหมดที่ตรงกับเทอม/ปี
2. สาย ปวส.: คำนวณจาก (จำนวนหน่วยกิตจริง x credit_fee) + ค่าบำรุงการศึกษาคงที่
3. ตรรกะค่าปรับ (Late Fee): ตรวจสอบวันที่ปัจจุบันเทียบกับ late_registration_start_date หากเกินกำหนดให้บวกค่าปรับ 100 บาทอัตโนมัติ

---

### [ส่วนที่ III: ส่วนประสานงานผู้ใช้ (UI/UX & Sidebar)]

1. โครงสร้าง Layout (Fixed Sidebar):
   - Sidebar ด้านซ้ายคงที่ (height: 100vh), ส่วนเนื้อหาด้านขวา (scrollable)
   - เมนูย่อยใช้แท็ก <details> พับได้ และมี Active Highlight สำหรับเมนูที่เลือก
   - แสดงชื่อผู้ใช้/ปุ่ม Log Out ที่ด้านล่างสุดของ Sidebar

2. การแบ่งเมนูตาม Role (Spatie):
   - Admin: จัดการ Users และสิทธิ์
   - Registrar: ตรวจสอบการลงทะเบียน (Approve/Reject), จัดการข้อมูลหลัก (Majors, Subjects, Semesters, Fees)
   - Teacher: ดูรายชื่อนักเรียนในที่ปรึกษา และสถานะการลงทะเบียนของเด็กในห้อง
   - Student: ดาวน์โหลดเอกสารลงทะเบียน (PDF) และอัปโหลดหลักฐานการชำระเงิน

---

### [ส่วนที่ IV: การจัดการเอกสาร PDF (PDF Template Mapping)]

ใช้ DomPDF เจนไฟล์เดียวที่มี 3 หน้ากระดาษตามแบบฟอร์มจริงของวิทยาลัย:
- หน้า 1 (Collection Details): หัวกระดาษวิทยาลัย, รายการเงินที่ต้องชำระ, ยอดรวมตัวอักษรไทย
- หน้า 2 (Pay-in Slip): 
    - แบ่งเป็นส่วนของนักเรียนและส่วนของธนาคาร
    - ต้องมี Company Code: 81245 และ Ref.2 (Course Group Code)
- หน้า 3 (Registration Card): ตารางวิชาที่ลงทะเบียน, หน่วยกิต, ช่องเซ็นชื่อครูที่ปรึกษาและเจ้าหน้าที่

---

### [ส่วนที่ V: ฟังก์ชันทางเทคนิค (Livewire & API)]

1. Livewire Components:
   - Registrar\ApproveRegistrations: กรองข้อมูลแบบ Multi-step (ปี -> สาขา -> กลุ่ม) พร้อมระบบ Bulk Action
   - Student\RegistrationUpload: ฟอร์มอัปโหลดสลิป (รองรับ jpg, png, pdf) พร้อม SweetAlert2
   - การเชื่อมต่อ SweetAlert2: ใช้ Livewire dispatch('swal') เพื่อแจ้งเตือนการบันทึกข้อมูล

2. API Security:
   - ป้องกันด้วย auth:sanctum
   - UserController: รองรับ CRUD และการ syncRoles() พร้อม Error Handling (404)

---

### [สิ่งที่ต้องการให้ AI สร้าง (Output Requested)]

1. ไฟล์ Migrations ทั้ง 13 ตาราง
2. ไฟล์ Models พร้อม Relationships ทั้งหมด
3. ไฟล์ Repositories (Interface & Eloquent)
4. ไฟล์ Seeders (Role, User, Level, Major, Subject, Semester, TuitionFee)
5. การตั้งค่า bootstrap/app.php และ routes (web.php, api.php)
6. PdfController และ Blade View สำหรับ PDF 3 หน้า
7. Layout app.blade.php และ navigation.blade.php (Sidebar)
8. Livewire Components สำหรับทุก Role ตามที่ระบุ